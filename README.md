# üí•Dimas MLIR Utilityüí•
## –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —è –Ω–∞–ø–∏—Å–∞–ª –≤ —Ä–∞–º–∫–∞—Ö —Å–≤–æ–µ–π –∏–Ω—Ç–µ—Ä–Ω–∞—Ç—É—Ä—ã –≤ **–ò–°–ü –†–ê–ù**.
–í –Ω–µ–º —è —Ä–µ–∞–ª–∏–∑—É—é **–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç**, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã MLIR –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∞–Ω–∞–ª–∏–∑ –∂–∏–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∞–Ω–∞–ª–∏–∑ –ø—Å–µ–≤–¥–æ–Ω–∏–º–æ–≤. –ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –æ–Ω —Å—Ç—Ä–æ–∏—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∂–∏–∑–Ω–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —É–¥–æ–±–Ω–æ–º –¥–ª—è —á—Ç–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–µ.
–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –¥–æ—Å—Ç—É–ø–Ω–æ –æ–ø–∏—Å–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —ç—Ç–æ–π —É—Ç–∏–ª–∏—Ç—ã.

<img src="assets/umnik.jpg" width="400">

## –ü–µ—Ä–≤—ã–µ —à–∞–≥–∏

–ü–µ—Ä–≤–æ–µ —Å —á–µ–≥–æ —Å–ª–µ–¥—É–µ—Ç —Å—Ç–æ–∏—Ç—å –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É, —ç—Ç–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç [llvm-project](https://github.com/llvm/llvm-project) –∏ —Å–æ–±—Ä–∞—Ç—å –µ–≥–æ —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º MLIR.

–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
https://mlir.llvm.org/getting_started/
https://mlir.llvm.org/docs/

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: —á—Ç–æ–±—ã –ª–µ–≥—á–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –∫–æ–¥, –¥–µ–ª–∞–π—Ç–µ **Debug** —Å–±–æ—Ä–∫—É. –¢–∞–∫ –∂–µ –º–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç —Å –æ–ø—Ü–∏–µ–π **BUILD_SHARED_LIBS** —á—Ç–æ–±—ã —Å–±–æ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∞–ª–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, —ç—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.

## "–°–∫–µ–ª–µ—Ç" –¥–ª—è mlir-opt —É—Ç–∏–ª–∏—Ç—ã

–ù–∞—á–Ω–µ–º —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.
–°–¥–µ–ª–∞–µ–º —ç—Ç–æ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

```
/ (project root)
|-include
| |-LATool
| | |-Passes.td
| | |-CMakeLists.txt
| | |-Passes.h
| |-CMakeLists.txt
|
|-lib
| |-LATool
| | |-LifeRangePass.cpp
| | |-CMakeLists.txt
| |-CMakeLists.txt
|
|-tools
| |-LATool
| | |-lr-mlir-opt.cpp
| | |-CMakeLists.txt
| |-CMakeLists.txt
|
|-test
| |-*.mlir
|
|-CMakeLists.txt
```


–ü—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π —É—Ç–∏–ª–∏—Ç—ã, —Å–ª–µ–¥—É–µ—Ç –Ω–∞—á–∞—Ç—å —Å –µ–µ "—Å–∫–µ–ª–µ—Ç–∞" - —Å–∞–º–æ–π –ø—Ä–æ—Å—Ç–æ–π –≤–µ—Ä—Å–∏–∏. –£—Å–ª–æ–≤–Ω–æ –Ω–∞–∑–æ–≤–µ–º –Ω–∞—à—É —É—Ç–∏–ª–∏—Ç—É **lr-mlir-opt**, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä **--liferange-analysis**, –∑–∞–ø—É—Å–∫–∞—é—â–∏–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π **pass** (–∫–æ—Ç–æ—Ä—ã–π –Ω–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ —É—Å–ª–æ–≤–Ω–æ –≤—ã–≤–µ–¥–µ—Ç Hello MLIR World).

**–í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ**: –æ—á–µ–Ω—å —É–¥–æ–±–Ω–æ –ø–∏—Å–∞—Ç—å —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ [Standalone](https://github.com/llvm/llvm-project/tree/main/mlir/examples/standalone) –∏–∑ MLIR Examples.
–¢–∞–º –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞ –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å Pass, –∫–∞–∫ –ø–∏—Å–∞—Ç—å –µ–≥–æ –ø—Ä–æ—Å—Ç–µ–π—à—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∏ –∫–∞–∫ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –ø–æ–º–æ—â—å—é **CMake** –∏ **tblgen** Passes.h.inc —Ñ–∞–π–ª. –¢–∞–º –∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤—Å–µ –¥–ª—è —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞.

–ü–æ—Å–ª–µ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ—Å—Ç–µ–π—à–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Pass'a –∏ –µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ lr-mlir-opt —É—Ç–∏–ª–∏—Ç–µ, –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–µ—à–∏—Ç—å –Ω–∞—à—É –∑–∞–¥–∞—á—É –¥–ª—è —Å–∞–º–æ–≥–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —Å–ª—É—á–∞—è.

## –°–ª—É—á–∞–π 1. –ü—Ä–æ—Å—Ç–µ–π—à–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∂–∏–∑–Ω–∏.

–ü—Ä–∏–º–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ —Å–ª—É—á–∞—è:
```llvm
func.func @test0() {
  %alloc = memref.alloc() : memref<16xf16>
  %c1 = arith.constant 1 : index
  %c1_i32 = arith.constant 1 : i32
  %cst = arith.constant 1.000000e+01 : f16
  %alloc_0 = memref.alloc() : memref<10xi32>
  %1 = memref.load %alloc[%c1] : memref<16xf16>
  %2 = arith.addf %1, %cst : f16
  memref.store %2, %alloc[%c1] : memref<16xf16>
  memref.store %c1_i32, %alloc_0[%c1] : memref<10xi32>
  return
}
```

–ï—Å—Ç—å –∫–ª–∞—Å—Å **Liveness** –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ **MLIR**, –≥–¥–µ –µ—Å—Ç—å –º–Ω–æ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö. –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ —Å–ª—É—á–∞—è, –º—ã –º–æ–∂–µ–º –≤—ã—Ç–∞—â–∏—Ç—å –ª–∏—à—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞—Ö –∂–∏–∑–Ω–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –≤—ã–≤–µ—Å—Ç–∏ –µ–µ –≤ —É–¥–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.

–ü—Ä–∏–º–µ—Ä dump'–∞ –∏–∑ Liveness –ê–Ω–∞–ª–∏–∑–∞ (–≤–∏–¥–Ω–æ, —á—Ç–æ –µ—Å—Ç—å –∫—É—á–∞ —Ä–∞–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏):
```
// ---- Liveness -----
// - Block: 0
// --- LiveIn: arg0@1 arg1@1
// --- LiveOut:
// --- BeginLivenessIntervals
// val_1 :
//     %alloc = memref.alloc() : memref<10xi32>
//     %c1_i32 = arith.constant 1 : i32
//     %cst = arith.constant 1.000000e+01 : f16
//     %c0 = arith.constant 0 : index
//     %c1 = arith.constant 1 : index
//     %c10 = arith.constant 10 : index
//     %0 = scf.for %arg1 = %c0 to %c10 step %c1 iter_args(%arg2 = %cst) -> (f16) {
  %1 = memref.load %arg0[%arg1] : memref<16xf16>
  memref.store %c1_i32, %alloc[%arg1] : memref<10xi32>
  %alloc_0 = memref.alloc() : memref<10xf16>
  %2 = arith.addf %1, %arg2 : f16
  memref.store %2, %alloc_0[%c1] : memref<10xf16>
  scf.yield %2 : f16
}
//     %1 = memref.load %arg0[%arg1] : memref<16xf16>
//     memref.store %c1_i32, %alloc[%arg1] : memref<10xi32>
```

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ –Ω–∞—à–µ–≥–æ Pass'–∞:

<img src="assets/dump.jpg" width="600">

## –°–ª—É—á–∞–π 2. –¶–∏–∫–ª—ã.

–ü—Ä–∏–º–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ —Å–ª—É—á–∞—è:
```llvm
// normal
func.func @test2(%input : memref<16xf16>) {
  %alloc = memref.alloc() : memref<10xi32>

  %c1_i32 = arith.constant 1 : i32
  %cst = arith.constant 1.000000e+01 : f16

  %c0 = arith.constant 0 : index
  %c1 = arith.constant 1 : index
  %c10 = arith.constant 10 : index
  %0 = scf.for %arg0 = %c0 to %c10 step %c1 iter_args(%arg1 = %cst) -> (f16) {
    %load = memref.load %input[%arg0] : memref<16xf16>
    memref.store %c1_i32, %alloc[%arg0] : memref<10xi32>

    %alloc_0 = memref.alloc() : memref<10xf16>

    %add = arith.addf %load, %arg1 : f16
    memref.store %add, %alloc_0[%c1] : memref<10xf16>

    scf.yield %add : f16
  }
  memref.store %0, %input[%c1] : memref<16xf16>
  return
}
```

–í —Ü–∏–∫–ª–∞—Ö –µ—Å—Ç—å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å, —Ç–∞–∫ –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ alloc —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –≤ —Ü–∏–∫–ª–µ, –≤ —Ä–∞–º–∫–∞—Ö –∑–∞–¥–∞–Ω–∏—è –º—ã —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è *–∂–∏–≤–∞ –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –≤—Å–µ–≥–æ —Ü–∏–∫–ª–∞ –∏ –±—É–¥–µ—Ç –º–µ—Ä—Ç–≤–∞ —Ç–æ–ª—å–∫–æ –≤ –µ–≥–æ –∫–æ–Ω—Ü–µ*. –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –Ω–∞–º –Ω—É–∂–Ω–æ –≤–Ω–µ—Å—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –≤ –ø–æ–¥—Å—á–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –∂–∏–∑–Ω–∏.

–í–Ω—É—Ç—Ä–∏ –Ω–∞—à–µ–≥–æ Pass'a –¥–æ–±–∞–≤–∏–º –æ—Ç–¥–µ–ª—å–Ω—ã–π ``` if (isa<scf::ForOp>(op)) ```, –≥–¥–µ –º—ã –∏ –≤–Ω–µ—Å–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª –∂–∏–∑–Ω–∏, –¥–æ–æ–ø—Ä–µ–¥–µ–ª–∏–≤ –∫–æ–Ω–µ—Ü –∂–∏–∑–Ω–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π, –∫–æ–Ω—Ü–æ–º –±–ª–æ–∫–∞ (```op.getRegions().back().back();```).


## –°–ª—É—á–∞–π 3. –ê–Ω–∞–ª–∏–∑ –ü—Å–µ–≤–¥–æ–Ω–∏–º–æ–≤

```llvm
/// hard (AliasAnalysis)
func.func @test3() {
  %alloc = memref.alloc() : memref<16xf16>
  %c0 = arith.constant 0 : index
  %c1 = arith.constant 1 : index
  %c1_i32 = arith.constant 1 : i32
  %c10 = arith.constant 10 : index
  %cst = arith.constant 1.000000e+01 : f16
  %0 = scf.for %arg0 = %c0 to %c10 step %c1 iter_args(%arg1 = %alloc) -> (memref<16xf16>) {
    memref.store %cst, %arg1[%arg0] : memref<16xf16>
    scf.yield %arg1 : memref<16xf16>
  }
  %alloc_0 = memref.alloc() : memref<10xi32>
  %1 = memref.load %0[%c1] : memref<16xf16>
  %2 = arith.addf %1, %cst : f16
  memref.store %2, %0[%c1] : memref<16xf16>
  memref.store %c1_i32, %alloc_0[%c1] : memref<10xi32>
  return
}
```

–≠—Ç–æ —Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π —Å–ª—É—á–∞–π - –∞–Ω–∞–ª–∏–∑ –ø—Å–µ–≤–¥–æ–Ω–∏–º–æ–≤ (**Alias Analysis**)).
–¢–æ–Ω–∫–æ—Å—Ç—å —ç—Ç–æ–≥–æ —Å–ª—É—á–∞—è, –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —É–∫–∞–∑–∞—Ç–µ–ª–µ–π, —É–∫–∞–∑—ã–≤–∞—é—â–∏—Ö –Ω–∞ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –±–ª–æ–∫ –ø–∞–º—è—Ç–∏. –í **Liveness Analysis**'–µ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Å–µ–≤–¥–æ–Ω–∏–º–æ–º –∏–ª–∏ –Ω–µ—Ç, –ø–æ—ç—Ç–æ–º—É –Ω–∞–º –Ω–∞–¥–æ –ø—Ä–∏–±–µ–≥–Ω—É—Ç—å –∫ –µ—â–µ –æ–¥–Ω–æ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É.

**Alias Analysis** - —ç—Ç–æ –∞–Ω–∞–ª–∏–∑ –≤–æ MLIR, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ—Å—Ç–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Å–µ–≤–¥–æ–Ω–∏–º–æ–º –∏–ª–∏ –Ω–µ—Ç.
–†–µ–∞–ª–∏–∑—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É, –∫–æ—Ç–æ—Ä–∞—è –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∂–∏–∑–Ω–∏ –≤—Å–µ—Ö –ø—Å–µ–≤–¥–æ–Ω–∏–º–æ–≤, —É–∫–∞–∑—ã–≤–∞—é—â–∏—Ö –Ω–∞ –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ. **Profit!!!**.

<img src="assets/utka.jpg" width="300">

üíò **Dmit DREC MIPT 2024**
